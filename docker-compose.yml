x-gokv-base: &gokv-base
  image: gokv
  expose:
    - "50051"
  deploy:
    resources:
      limits:
        cpus: '0.5'
        memory: 512M
      reservations:
        cpus: '0.25'
        memory: 128M
  volumes:
    - ./certs:/app/certs
    - ./config.yml:/app/config.yaml

services:
  gokv1:
    <<: *gokv-base
    build:
      context: ./
      dockerfile: Dockerfile
    ports:
      - "50051:50051"
    environment:
      NODE_ID: "gokv1"
      HOST: "gokv1"
      PORT: 50051
      TLS_CERT_PATH: ""
      TLS_KEY_PATH: ""
      CONFIG_PATH: "/app/config.yaml"
    
  gokv2:
    <<: *gokv-base
    ports:
      - "50052:50051"
    environment:
      NODE_ID: "gokv2"
      HOST: "gokv2"
      PORT: 50051
      SEED_NODE_ID: "gokv1"
      SEED_NODE_ADDR: "gokv1:50051"
      TLS_CERT_PATH: ""
      TLS_KEY_PATH: ""
      CONFIG_PATH: "/app/config.yaml"
    depends_on:
      - gokv1

  gokv3:
    <<: *gokv-base
    ports:
      - "50053:50051"
    environment:
      NODE_ID: "gokv3"
      HOST: "gokv3"
      PORT: 50051
      SEED_NODE_ID: "gokv1"
      SEED_NODE_ADDR: "gokv1:50051"
      TLS_CERT_PATH: ""
      TLS_KEY_PATH: ""
      CONFIG_PATH: "/app/config.yaml"
    depends_on:
      - gokv1

networks:
  gokv-cluster:
    driver: bridge
